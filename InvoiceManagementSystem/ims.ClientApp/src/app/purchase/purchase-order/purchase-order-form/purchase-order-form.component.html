<div class="invoice-container">
    <form [formGroup]="form" (ngSubmit)="save()">
        <!-- Toolbar -->
        <div class="d-flex justify-content-end mb-4 gap-2 no-print">
            <button type="button" class="btn btn-secondary btn-sm" (click)="cancel()">Cancel</button>
            <button type="submit" class="btn btn-primary btn-sm" [disabled]="form.invalid">
                <i class="las la-save"></i> {{ isEditMode ? 'Update' : 'Save' }} PO
            </button>
        </div>

        <div class="header-title">
            PURCHASE ORDER {{ isEditMode ? '(EDIT)' : '(NEW)' }}
        </div>

        <div class="company-section align-items-start">
            <div class="company-info">
                <div class="company-logo text-start mb-2" *ngIf="companyLogoUrl; else companyNameFallback">
                    <img [src]="companyLogoUrl" alt="{{ companyInfo.name }}" class="company-logo-img">
                </div>
                <ng-template #companyNameFallback>
                    <div class="company-logo text-start mb-2">{{ companyInfo.name || 'Company' }}</div>
                </ng-template>
                <h4 class="fw-bold" *ngIf="companyInfo.name">{{ companyInfo.name }}</h4>
                <p class="mb-1">{{ companyInfo.address }}</p>
                <p class="mb-1">{{ companyInfo.cityStateZip }}</p>
                <div class="text-muted small" *ngIf="companyInfo.email || companyInfo.phone || companyInfo.taxNumber">
                    <div *ngIf="companyInfo.email">Email: {{ companyInfo.email }}</div>
                    <div *ngIf="companyInfo.phone">Phone: {{ companyInfo.phone }}</div>
                    <div *ngIf="companyInfo.taxNumber">Tax #: {{ companyInfo.taxNumber }}</div>
                </div>
            </div>
            <div class="supplier-wrapper">
                <div class="card shadow-sm supplier-card">
                    <div class="card-header bg-light py-2">
                        <div class="row g-2 align-items-center">
                            <div class="col-auto">
                                <strong>Select Supplier</strong>
                            </div>
                            <div class="col">
                                <select class="form-select form-select-sm" formControlName="vendorId">
                                    <option value="">-- Choose Supplier --</option>
                                    <option *ngFor="let v of vendors" [value]="v.id">{{ v.name }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <div *ngIf="selectedVendor">
                            <h6 class="mb-1">{{ selectedVendor.name }}</h6>
                            <div class="small text-muted">
                                <ng-container *ngIf="selectedVendor.address">
                                    <div>{{ selectedVendor.address.line1 }}</div>
                                    <div *ngIf="selectedVendor.address.line2">{{ selectedVendor.address.line2 }}</div>
                                    <div>
                                        <ng-container *ngIf="selectedVendor.address.city">{{ selectedVendor.address.city.name }}, </ng-container>
                                        <ng-container *ngIf="selectedVendor.address.state">{{ selectedVendor.address.state.name }} </ng-container>
                                        <ng-container *ngIf="selectedVendor.address.postalCode">{{ selectedVendor.address.postalCode.code }}</ng-container>
                                    </div>
                                    <div *ngIf="selectedVendor.address.country">{{ selectedVendor.address.country.name }}</div>
                                </ng-container>
                                <ng-container *ngIf="!selectedVendor.address">No Address Provided</ng-container>
                            </div>
                        </div>
                        <div *ngIf="!selectedVendor" class="text-muted small">
                            Select a supplier to view details
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mt-2">
            <div class="card-header bg-light py-1">
                <strong class="small">PO Details</strong>
            </div>
            <div class="card-body p-2">
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label small">PO Number</label>
                        <input type="text" class="form-control form-control-sm" formControlName="reference"
                            placeholder="PO-0000">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small">Date</label>
                        <input type="text" class="form-control form-control-sm"
                            [value]="(form.get('orderDate')?.value || now) | date:'mediumDate'" disabled>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small">Warehouse</label>
                        <select class="form-select" formControlName="warehouseId">
                            <option value="">-- Select Warehouse --</option>
                            <option *ngFor="let w of warehouses" [value]="w.id">{{ w.name }}</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Items Table -->
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 5%;">#</th>
                    <th style="width: 40%;">Description / Item</th>
                    <th style="width: 15%; text-align: center;">Qty</th>
                    <th style="width: 20%; text-align: right;">Rate</th>
                    <th style="width: 15%; text-align: right;">Amount</th>
                    <th style="width: 5%;"></th>
                </tr>
            </thead>
            <tbody formArrayName="lines">
                <tr *ngFor="let line of lines.controls; let i=index" [formGroupName]="i">
                    <td>{{ i + 1 }}</td>
                    <td>
                        <select class="form-select form-select-sm" formControlName="itemId">
                            <option value="">Select Item</option>
                            <option *ngFor="let item of items" [value]="item.id">{{ item.name }} ({{ item.sku }})
                            </option>
                        </select>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-center"
                            formControlName="quantityOrdered" placeholder="0">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-end" formControlName="unitPrice"
                            placeholder="0.00">
                    </td>
                    <td style="text-align: right;">
                        {{ (line.get('quantityOrdered')?.value * line.get('unitPrice')?.value) | currency }}
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-link text-danger" (click)="removeLine(i)">
                            <i class="las la-trash"></i>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="mb-2">
            <button type="button" class="btn btn-sm btn-outline-primary" (click)="addLine()">
                <i class="las la-plus"></i> Add Item
            </button>
        </div>

        <div class="totals-section">
            <table class="totals-table">
                <tr class="grand-total">
                    <td class="label">Total</td>
                    <td>{{ calculateTotal() | currency }}</td>
                </tr>
            </table>
        </div>

    </form>
</div>