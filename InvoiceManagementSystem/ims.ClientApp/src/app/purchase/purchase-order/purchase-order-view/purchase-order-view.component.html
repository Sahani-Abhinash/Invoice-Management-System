<div class="invoice-container">
    <div *ngIf="isLoading" class="text-center p-5">Loading...</div>
    <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

    <div *ngIf="!isLoading && po">
        <!-- Toolbar -->
        <div class="d-flex justify-content-end mb-4 no-print gap-2">
            <button class="btn btn-secondary btn-sm" (click)="back()">
                <i class="las la-arrow-left"></i> Back
            </button>
            <button *ngIf="po.isApproved && !po.isClosed" class="btn btn-success btn-sm" (click)="receiveGoods()">
                <i class="las la-truck-loading"></i> Receive Goods
            </button>
            <button class="btn btn-primary btn-sm" (click)="print()">
                <i class="las la-print"></i> Print
            </button>
        </div>

        <!-- Title -->
        <div class="header-title">
            PURCHASE ORDER
        </div>

        <!-- Company Info & Supplier -->
        <div class="company-section align-items-start">
            <div class="company-info">
                <div class="company-logo text-start mb-2">
                    <ng-container *ngIf="companyLogoUrl; else poLogoPlaceholder">
                        <img [src]="companyLogoUrl" alt="Company logo" class="company-logo-img">
                    </ng-container>
                    <ng-template #poLogoPlaceholder>
                        <span class="fw-bold text-primary">{{ company?.name || 'Company' }}</span>
                    </ng-template>
                </div>
                <h4>{{ company?.name || '—' }}</h4>
                <p class="mb-1">{{ companyAddress?.line1 || '—' }}</p>
                <p class="mb-1">
                    <ng-container *ngIf="companyAddress; else cityFallback">
                        {{ companyAddress.city?.name || '' }}<span *ngIf="companyAddress.state?.name">, {{ companyAddress.state?.name }}</span>
                        <span *ngIf="companyAddress.postalCode?.code"> {{ companyAddress.postalCode?.code }}</span>
                        <span *ngIf="companyAddress.country?.name"> | {{ companyAddress.country?.name }}</span>
                    </ng-container>
                    <ng-template #cityFallback>—</ng-template>
                </p>
                <p class="mb-1">Mobile: {{ company?.phone || '—' }}</p>
                <p class="mb-0">Email: {{ company?.email || '—' }}</p>
            </div>
            <div class="supplier-wrapper">
                <div class="card shadow-sm supplier-card">
                    <div class="card-header bg-light py-2">
                        <strong>Supplier</strong>
                    </div>
                    <div class="card-body">
                        <div *ngIf="isLoadingDetails" class="text-muted small">Loading supplier info...</div>
                        <div *ngIf="!isLoadingDetails && vendor">
                            <div class="fw-semibold">{{ vendor.name }}</div>
                            <div class="small text-muted">
                                <ng-container *ngIf="vendor.address">
                                    {{ vendor.address.line1 }}<br>
                                    <ng-container *ngIf="vendor.address.line2">{{ vendor.address.line2 }}<br></ng-container>
                                    <ng-container *ngIf="vendor.address.city">{{ vendor.address.city.name }}, </ng-container>
                                    <ng-container *ngIf="vendor.address.state">{{ vendor.address.state.name }} </ng-container>
                                    <ng-container *ngIf="vendor.address.postalCode">{{ vendor.address.postalCode.code }}</ng-container>
                                    <ng-container *ngIf="vendor.address.country"><br>{{ vendor.address.country.name }}</ng-container>
                                </ng-container>
                                <ng-container *ngIf="!vendor.address">No Address Provided</ng-container>
                                <div *ngIf="vendor.email">{{ vendor.email }}</div>
                                <div *ngIf="vendor.phone">{{ vendor.phone }}</div>
                            </div>
                        </div>
                        <div *ngIf="!isLoadingDetails && !vendor" class="text-danger small">Vendor not found (ID: {{ po.vendorId }})</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mt-3">
            <div class="card-header bg-light py-2">
                <strong>PO Details</strong>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="small text-muted">PO No</div>
                        <div class="fw-semibold">{{ po.reference }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="small text-muted">Date</div>
                        <div class="fw-semibold">{{ po.orderDate | date:'mediumDate' }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="small text-muted">Warehouse</div>
                        <div class="fw-semibold">{{ warehouse?.name || 'N/A' }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Items Table -->
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 50px;">Sl.</th>
                    <th style="width: 80px;">Image</th>
                    <th>Description</th>
                    <th style="width: 80px; text-align: center;">Qty</th>
                    <th style="width: 120px;">Rate</th>
                    <th style="width: 120px;">Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let line of po.lines; let i = index">
                    <td>{{ i + 1 }}</td>
                    <td>
                        <div class="item-thumb-wrapper">
                            <ng-container *ngIf="getItemImage(line.itemId) as imageUrl; else poThumbPlaceholder">
                                <img [src]="imageUrl" alt="Item image" class="item-thumb">
                            </ng-container>
                            <ng-template #poThumbPlaceholder>
                                <div class="item-thumb placeholder">
                                    <i class="las la-image"></i>
                                </div>
                            </ng-template>
                        </div>
                    </td>
                    <td>
                        <div *ngIf="isLoadingDetails">Loading Item...</div>
                        <div *ngIf="!isLoadingDetails">
                            <span style="font-weight: 500;">{{ getItem(line.itemId)?.name || 'Unknown Item' }}</span>
                            <br>
                            <small class="text-muted">{{ getItem(line.itemId)?.sku || line.itemId }}</small>
                        </div>
                    </td>
                    <td style="text-align: center;">{{ line.quantityOrdered }}</td>
                    <td style="text-align: right;">{{ line.unitPrice | currency }}</td>
                    <td style="text-align: right;">{{ (line.quantityOrdered * line.unitPrice) | currency }}</td>
                </tr>
            </tbody>
        </table>

        <!-- Totals -->
        <div class="totals-section">
            <table class="totals-table">
                <tr>
                    <td class="label">Subtotal</td>
                    <td>{{ totalAmount | currency }}</td>
                </tr>
                <tr class="grand-total">
                    <td class="label">Total</td>
                    <td>{{ totalAmount | currency }}</td>
                </tr>
            </table>
        </div>

        <!-- Footer / Signature -->
        <div class="footer-section">
            <div class="payment-instructions">
                <h6 style="font-weight: 700;">Payment Instructions</h6>
                <p class="text-muted small">
                    Payment within 30 days.<br>
                    Bank: City Bank<br>
                    Acct: 1234567890
                </p>
            </div>
            <div class="signature">
                <div class="signature-line"></div>
                <span class="small" style="font-weight: 600;">Authorized Signatory</span>
            </div>
        </div>
    </div>
</div>