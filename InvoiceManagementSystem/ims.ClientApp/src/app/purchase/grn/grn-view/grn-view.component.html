<div class="invoice-container">
    <div *ngIf="isLoading" class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

    <div *ngIf="!isLoading && grn">
        <!-- Toolbar -->
        <div class="d-flex justify-content-end mb-4 no-print gap-2">
            <button class="btn btn-secondary btn-sm" (click)="back()">
                <i class="las la-arrow-left"></i> Back
            </button>
            <button *ngIf="!grn.isReceived" class="btn btn-info btn-sm text-white" (click)="edit()">
                <i class="las la-edit"></i> Edit
            </button>
            <button *ngIf="!grn.isReceived" class="btn btn-success btn-sm" (click)="receiveAndPay()">
                <i class="las la-check-double"></i> Receive & Pay Now
            </button>
            <button *ngIf="!grn.isReceived" class="btn btn-success btn-sm" (click)="receive()">
                <i class="las la-check"></i> Mark as Received
            </button>
            <button *ngIf="grn.isReceived" 
                class="btn btn-warning btn-sm text-white" 
                [routerLink]="['/grns', grn.id, 'payment']"
                title="Record partial or full payment for this GRN">
                <i class="las la-money-bill-wave"></i> Record Payment
            </button>
            <button *ngIf="grn.isReceived" 
                class="btn btn-info btn-sm text-white" 
                [routerLink]="['/grns', grn.id, 'payment-receipt']"
                title="View payment receipt">
                <i class="las la-receipt"></i> Payment Receipt
            </button>
            <button class="btn btn-primary btn-sm" (click)="print()">
                <i class="las la-print"></i> Print
            </button>
        </div>

        <!-- Title -->
        <div class="header-title">
            GOODS RECEIPT NOTE (GRN)
        </div>

        <!-- Top Section: Company Info, Supplier, Warehouse -->
        <div class="row mb-2">
            <!-- Company Info -->
            <div class="col-md-4">
                <div class="company-logo text-start mb-2">
                    <ng-container *ngIf="companyLogoUrl; else grnLogoPlaceholder">
                        <img [src]="companyLogoUrl" alt="Company logo" class="company-logo-img">
                    </ng-container>
                    <ng-template #grnLogoPlaceholder>
                        <span class="fw-bold text-primary">{{ company?.name || 'Company' }}</span>
                    </ng-template>
                </div>
                <h6 class="fw-bold">{{ company?.name || '—' }}</h6>
                <p class="small mb-0">
                    {{ companyAddress?.line1 || '—' }}<br>
                    <ng-container *ngIf="companyAddress; else grnAddrFallback">
                        {{ companyAddress.city?.name || '' }}<span *ngIf="companyAddress.state?.name">, {{ companyAddress.state?.name }}</span>
                        <span *ngIf="companyAddress.postalCode?.code"> {{ companyAddress.postalCode?.code }}</span><br>
                        <span *ngIf="companyAddress.country?.name">{{ companyAddress.country?.name }}</span><br>
                    </ng-container>
                    <ng-template #grnAddrFallback>—</ng-template>
                    Mobile: {{ company?.phone || '—' }}<br>
                    Email: {{ company?.email || '—' }}
                </p>
            </div>

            <!-- Supplier -->
            <div class="col-md-4">
                <h6 class="fw-bold mb-2"><i class="las la-truck"></i> Ship From (Supplier)</h6>
                <div *ngIf="isLoadingDetails" class="text-muted small">Loading supplier info...</div>
                <div *ngIf="!isLoadingDetails && vendor">
                    <p class="mb-1 fw-semibold small">{{ vendor.name }}</p>
                    <p class="small text-muted mb-0">
                        <ng-container *ngIf="vendor.address">
                            {{ vendor.address.line1 }}<br>
                            <ng-container *ngIf="vendor.address.line2">{{ vendor.address.line2 }}<br></ng-container>
                            <ng-container *ngIf="vendor.address.city">{{ vendor.address.city.name }}, </ng-container>
                            <ng-container *ngIf="vendor.address.state">{{ vendor.address.state.name }} </ng-container>
                            <ng-container *ngIf="vendor.address.postalCode">{{ vendor.address.postalCode.code }}</ng-container>
                            <ng-container *ngIf="vendor.address.country"><br>{{ vendor.address.country.name }}</ng-container>
                        </ng-container>
                        <ng-container *ngIf="!vendor.address">No Address Provided</ng-container>
                    </p>
                </div>
                <div *ngIf="!isLoadingDetails && !vendor">
                    <p class="text-danger small">Vendor information not found</p>
                </div>
            </div>

            <!-- Warehouse -->
            <div class="col-md-4">
                <h6 class="fw-bold mb-2"><i class="las la-warehouse"></i> Delivery To (Warehouse)</h6>
                <div *ngIf="isLoadingDetails" class="text-muted small">Loading warehouse info...</div>
                <div *ngIf="!isLoadingDetails && warehouse">
                    <p class="mb-1 small fw-semibold">{{ warehouse.name }}</p>
                    <ng-container *ngIf="warehouse.branch">
                        <p class="small text-muted mb-0">
                            {{ warehouse.branch.name }}<br>
                            <ng-container *ngIf="warehouse.branch.address">
                                {{ warehouse.branch.address.line1 }}<br>
                                <ng-container *ngIf="warehouse.branch.address.line2">{{ warehouse.branch.address.line2 }}<br></ng-container>
                                <ng-container *ngIf="warehouse.branch.address.city">{{ warehouse.branch.address.city.name }}, </ng-container>
                                <ng-container *ngIf="warehouse.branch.address.state">{{ warehouse.branch.address.state.name }} </ng-container>
                                <ng-container *ngIf="warehouse.branch.address.postalCode">{{ warehouse.branch.address.postalCode.code }}</ng-container>
                            </ng-container>
                        </p>
                    </ng-container>
                </div>
            </div>
        </div>

        <!-- GRN Meta in Single Row -->
        <div class="mb-3 p-2 bg-light border rounded">
            <div class="row">
                <div class="col-md-3">
                    <span class="text-muted small">GRN No:</span>
                    <strong class="ms-2">{{ grn.reference }}</strong>
                </div>
                <div class="col-md-3">
                    <span class="text-muted small">Date:</span>
                    <span class="ms-2">{{ grn.receivedDate | date:'mediumDate' }}</span>
                </div>
                <div class="col-md-3" *ngIf="purchaseOrder">
                    <span class="text-muted small">PO Ref:</span>
                    <span class="ms-2">{{ purchaseOrder.reference }}</span>
                </div>
                <div class="col-md-3">
                    <span class="text-muted small">Status:</span>
                    <span class="ms-2">
                        <span *ngIf="grn.isReceived" class="badge bg-success">RECEIVED</span>
                        <span *ngIf="!grn.isReceived" class="badge bg-warning">PENDING</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Items Table -->
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 50px;">Sl.</th>
                    <th style="width: 80px;">Image</th>
                    <th>Description</th>
                    <th style="width: 80px; text-align: center;">Qty</th>
                    <th style="width: 120px; text-align: right;">Rate</th>
                    <th style="width: 120px; text-align: right;">Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let line of grn.lines; let i = index">
                    <td>{{ i + 1 }}</td>
                    <td>
                        <div class="item-thumb-wrapper">
                            <ng-container *ngIf="getItemImage(line.itemId) as imageUrl; else grnThumbPlaceholder">
                                <img [src]="imageUrl" alt="Item image" class="item-thumb">
                            </ng-container>
                            <ng-template #grnThumbPlaceholder>
                                <div class="item-thumb placeholder">
                                    <i class="las la-image"></i>
                                </div>
                            </ng-template>
                        </div>
                    </td>
                    <td>
                        <div *ngIf="isLoadingDetails">Loading Item...</div>
                        <div *ngIf="!isLoadingDetails">
                            <span style="font-weight: 500;">{{ getItem(line.itemId)?.name || 'Unknown Item' }}</span>
                            <br>
                            <small class="text-muted">{{ getItem(line.itemId)?.sku || line.itemId }}</small>
                        </div>
                    </td>
                    <td style="text-align: center;">{{ line.quantity }}</td>
                    <td style="text-align: right;">{{ line.unitPrice | currency }}</td>
                    <td style="text-align: right;">{{ (line.quantity * line.unitPrice) | currency }}</td>
                </tr>
            </tbody>
        </table>

        <!-- Totals -->
        <div class="totals-section">
            <table class="totals-table">
                <tr>
                    <td class="label">Subtotal</td>
                    <td>{{ totalAmount | currency }}</td>
                </tr>
                <tr class="grand-total">
                    <td class="label">Total</td>
                    <td>{{ totalAmount | currency }}</td>
                </tr>
            </table>
        </div>

        <!-- Footer / Signature -->
        <div class="footer-section">
            <div class="notes">
                <h6 style="font-weight: 700;">Notes</h6>
                <p class="text-muted small">
                    This Goods Receipt Note confirms the physical receipt of goods into the warehouse.<br>
                    Stock levels have been updated accordingly if marked as 'Received'.
                </p>
            </div>
            <div class="signature">
                <div class="signature-line"></div>
                <span class="small" style="font-weight: 600;">Store Manager Signature</span>
            </div>
        </div>
    </div>
</div>